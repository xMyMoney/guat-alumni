<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zwx.guatalumni.module.alumni.dao.AlumniMapper">

    <select id="getTotal" resultType="java.lang.Integer">
        select count(a.id)
        from alumni a left join major ma on(a.major_id = ma.id)
                      left join academy ac on(a.academy_id = ac.id)
        where a.is_delete = 0
        <if test="username != '' and username != null">
            and username like concat('%',#{username},'%')
        </if>
        <if test="stuId != '' and stuId != null">
            and stu_id = #{stuId}
        </if>
        <if test="endYear != '' and endYear != null">
            and end_year  = #{endYear}
        </if>
        <if test="star != '' and star != null">
            and star = #{star}
        </if>
        <if test="status != '' and status != null">
            and status = #{status}
        </if>
    </select>
    <select id="getList" resultType="com.zwx.guatalumni.module.alumni.model.vo.AlumniListVo">
        select a.id, a.username, a.stu_id, a.education,
               ac.name as academy, ma.name as major,a.end_year,a.star, a.`status`
        from alumni a left join major ma on(a.major_id = ma.id)
                      left join academy ac on(a.academy_id = ac.id)
        where a.is_delete = 0
        <if test="username != '' and username != null">
            and username like concat('%',#{username},'%')
        </if>
        <if test="stuId != '' and stuId != null">
            and stu_id like concat('%',#{stuId},'%')
        </if>
        <if test="endYear != '' and endYear != null">
            and end_year  = #{endYear}
        </if>
        <if test="star != '' and star != null">
            and star = #{star}
        </if>
        <if test="status != null">
            and status = #{status}
        </if>
        limit #{current},#{pageSize}
    </select>
    <select id="getAuthInfo" resultType="com.zwx.guatalumni.module.alumni.model.vo.AlumniAuthInfo">
        select a.id,a.stu_id,a.begin_year,a.end_year,a.education,ac.name as academy,ma.name as major,a.`status`,a.auth_time
        from alumni a left join academy ac on(a.academy_id = ac.id)
                      left join major ma on(ac.id = ma.academy_id)
        where a.is_delete = 0 and a.id = #{id}
    </select>
    <select id="statisticsById" resultType="com.zwx.guatalumni.module.alumni.model.vo.AlumniStatisticsVo">
        select count(dr.id) as donationCount,count(ar.id) as activityCount
        from alumni a
                 left join donation_record dr on(a.id = dr.alumni_id)
                 left join activity_record ar on(a.id = ar.alumni_id)
        where a.id = #{id}
    </select>
    <select id="getCardList" resultType="com.zwx.guatalumni.module.alumni.model.vo.AlumniFriendVo">
        select
            a.id,
            a.avatar,
            a.username,
            m.`name` as major,
            a.address,
            a.company,
            a.jor,
            a.begin_year,
            a.end_year,
            a.education,
            a.gender,
            a.login_time,
            a.phone
        from
            alumni a left join major m on(a.major_id = m.id)
        where a.is_delete = 0 and a.id != #{alumniId}
        <if test="searchKey != '' and searchKey != null">
            and a.username like concat('%',#{searchKey},'%')
        </if>
        <choose>
            <when test="searchType == 1">
                and a.begin_year = (select begin_year from alumni where id = #{alumniId})
            </when>
            <when test="searchType == 2">
                and a.academy_id = (select academy_id from alumni where id = #{alumniId})
            </when>
            <when test="searchType == 3">
                and a.major_id = (select major_id from alumni where id = #{alumniId})
            </when>
            <otherwise>

            </otherwise>
        </choose>
        order by
        <choose>
            <when test="sortType == 0">
                a.login_time
            </when>
            <when test="sortType == 1">
                a.star
            </when>
            <when test="sortType == 2">
                a.begin_year
            </when>
            <otherwise>
                a.login_time
            </otherwise>
        </choose>
        desc limit #{current},#{pageSize}
    </select>
    <select id="getAlumniInfo" resultType="com.zwx.guatalumni.module.alumni.model.vo.AlumniInfoVo"></select>
</mapper>
